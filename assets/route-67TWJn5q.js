import{D as e,L as t,N as n,R as r,V as i,j as a,k as o,z as s}from"./chunk-JZWAC4HX-pontpNwO.js";import{t as c}from"./jsx-runtime-Dg8orHAx.js";import{t as l}from"./Svg-Boi9_9HN.js";import{t as u}from"./useRootLoaderData-DQMeRxtp.js";import{n as d,o as f,t as p}from"./packages-TGpPiuli.js";import{t as m}from"./ItemCard-sX9X9Rp8.js";import"./Input-Cb6DeJHz.js";import{t as h}from"./formatLocalDate-CRv1zltC.js";import{t as g}from"./clients-CSXVs_1P.js";import{i as _}from"./SkeletonString-ClGUZjJc.js";import{t as v}from"./AttendanceCard-1Yay7N-_.js";import"./Select-BMcBtPcw.js";import{n as y,r as b,t as x}from"./reports.settings-Dj1_pqE3.js";var S=c(),C=i(s(),1);const w=async({request:t})=>{let n=new URL(t.url),r=n.searchParams.get(`dateRange`),i=n.searchParams.get(`from`),a=n.searchParams.get(`to`),o=!1;if(r||(r=`today`,[i,a]=_(`today`,Date.now()),o=!0),a||(a=h(new Date),o=!0),(!i||new Date(i)>new Date(a))&&(i=a,o=!0),o)throw n.searchParams.set(`dateRange`,r),n.searchParams.set(`from`,i),n.searchParams.set(`to`,a),e(n.toString());let[s,c,l]=await Promise.all([g.getAllSortedByName(),p.getAllActive(),d.getByDateRange(i,a)]),u=c.reduce((e,t)=>(e[t.clientId]||(e[t.clientId]=[]),e[t.clientId].push(t),e),{}),f=s.map(e=>{let t=(u[e.id]??[]).reduce((e,t)=>e+t.remainingSessions,0);return{...e,remainingSessions:t}}),m=n.searchParams.get(`clientId`);return{clients:f,attendance:m?l.filter(e=>e.clientId===m):l}},T=async({request:e})=>{if(e.method!==`POST`)return new Response(`Method Not Allowed`,{status:405});let t=await e.formData(),n=t.get(`actionType`);if(!n)return new Response(`Missing actionType`,{status:400});switch(n){case`add`:{let e=t.get(`clientId`),n=t.get(`date`),r=[];if(e||r.push(`clientId`),n||r.push(`date`),r.length>0)return new Response(`Missing properties: ${r.join(`, `)}`,{status:400});try{return await d.create({clientId:e,date:new Date(n).getTime()}),{ok:!0,error:null}}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Ошибка при добавлении посещения`}}}case`addSingle`:{let e=t.get(`date`),n=t.get(`cost`),r=t.get(`clientName`),i=[];if(e||i.push(`date`),n||i.push(`cost`),r||i.push(`clientName`),i.length>0)return new Response(`Missing properties: ${i.join(`, `)}`,{status:400});let a=Number(n);if(isNaN(a)||a<0)return new Response(`Invalid cost value`,{status:400});let o=new Date(e).getTime();try{return console.log(`Creating single-session package`),await p.create({clientId:`single-session`,date:o,totalSessions:1,remainingSessions:0,cost:a,clientName:r}),await d.createSingleSession(o,a,r),{ok:!0,error:null}}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Ошибка при добавлении разового посещения`}}}case`delete`:{let e=t.get(`attendanceId`);if(!e)return new Response(`Missing attendanceId for delete action`,{status:400});try{return await d.delete(e),{ok:!0,error:null}}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Ошибка при удалении посещения`}}}default:return new Response(`Unknown actionType`,{status:400})}};var E=()=>{let{now:e}=u(),{clients:r,attendance:i}=a(),[o]=t(),s=n(),c=o.get(`dateRange`)??`today`;return(0,S.jsxs)(f,{children:[(0,S.jsx)(v,{attendance:i,ranges:x,activeRange:c,setRange:t=>{let n=new URLSearchParams(o);if(n.set(`dateRange`,t),t!==`custom`){let[r,i]=_(t,e);n.set(`from`,r),n.set(`to`,i)}s({search:n.toString()},{replace:!0})}}),(0,S.jsxs)(m,{background:`bg-accent-tertiary/15`,children:[c===`custom`&&(0,S.jsx)(b,{}),(0,S.jsx)(y,{clients:r})]}),(0,S.jsx)(D,{})]})},D=()=>{let{attendance:e,clients:t}=a(),n=o(),r=(0,C.useMemo)(()=>{let e={};return t.forEach(t=>{e[t.id]=t.name}),e},[t]);if(e.length<1)return(0,S.jsxs)(`div`,{className:`text-center py-12 text-gray-500`,children:[(0,S.jsx)(`p`,{className:`text-base mb-2`,children:`Нет отметок`}),(0,S.jsx)(`p`,{className:`text-sm`,children:`Отметьте клиентов, которые посетили тренировку`})]});let i=e=>{confirm(`Вы уверены, что хотите удалить эту отметку посещения?`)&&n.submit({actionType:`delete`,attendanceId:e},{method:`post`})};return(0,S.jsx)(`div`,{className:`space-y-3`,children:e.map(e=>(0,S.jsxs)(m,{children:[(0,S.jsxs)(`div`,{className:`flex justify-between items-start`,children:[(0,S.jsx)(`div`,{className:`font-medium text-base text-title`,children:r[e.clientId]??e.clientName??`Неизвестный`}),(0,S.jsx)(`button`,{onClick:()=>i(e.id),className:`btn-icon p-1 -mx-1`,"aria-label":`Удалить отметку посещения`,children:(0,S.jsx)(l,{name:`remove`,className:`size-4`})})]}),(0,S.jsxs)(`div`,{className:`flex justify-between items-center`,children:[(0,S.jsxs)(`div`,{className:`text-sm text-accent-secondary/70`,children:[e.sessionCost.toLocaleString(`ru-RU`),` ₽`]}),(0,S.jsx)(`div`,{className:`text-sm text-text-medium`,children:new Date(e.date).toLocaleDateString(`ru-RU`)})]})]},e.id))})},O=r(E);export{T as clientAction,w as clientLoader,O as default};