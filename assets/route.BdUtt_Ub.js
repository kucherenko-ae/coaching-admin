import{P as e,R as t,k as n,n as r,z as i}from"./chunk-JZWAC4HX.B5xnh8v2.js";import{t as a}from"./jsx-runtime.CWlfk1IU.js";import"./Svg.8sPTxAw7.js";import{t as o}from"./toggleThemeColor.B0EOo6XA.js";import{n as s,o as c,t as l}from"./packages.DEKZB-8t.js";import{t as u}from"./formatLocalDate.DBnePfWG.js";import{t as d}from"./Button.kaO_hKy8.js";import{t as f}from"./clients.BJCayMAs.js";import{t as p}from"./Message.CMOfVgep.js";import{t as m}from"./Select.BOD9nWkC.js";const h=(e,t)=>{let n=e%10,r=e%100;return n===1&&r!==11?t[0]:n>=2&&n<=4&&(r<10||r>=20)?t[1]:t[2]};var g=a(),_=i();const v=async({request:e})=>{if(e.method!==`POST`)return new Response(`Method Not Allowed`,{status:405});let t=await e.formData(),n=t.get(`actionType`);if(!n)return new Response(`Missing actionType`,{status:400});switch(n){case`export`:try{let e=u(new Date),[t,n,r]=await Promise.all([f.getAllSortedByName(),l.getAll(),s.getAll()]),i={exportDate:e,clients:t,packages:n,attendance:r},a=JSON.stringify(i,null,2),o=new Blob([a],{type:`application/json`}),c=URL.createObjectURL(o),d=document.createElement(`a`);return d.href=c,d.download=`ft-desk-data-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(c),null}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Ошибка при экспорте`}}case`import`:try{let e=t.get(`file`);if(!e||!(e instanceof File))return{ok:!1,error:`Файл не выбран`};let n=await e.text(),r=JSON.parse(n);return await Promise.all([f.import(r.clients),l.import(r.packages),s.import(r.attendance)]),{ok:!0,imported:{clients:r.clients.length,packages:r.packages.length,attendance:r.attendance.length}}}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Ошибка при импорте`}}case`startNewMonth`:try{return await Promise.all([s.clear(),l.clearInactive()]),{ok:!0,message:`Новый месяц успешно начат`}}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Ошибка при начале нового месяца`}}case`clearAll`:try{return await Promise.all([f.clear(),l.clear(),s.clear()]),{ok:!0,message:`Все данные успешно удалены`}}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Ошибка при удалении данных`}}default:return new Response(`Unknown action`,{status:400})}};var y=`_preferred_theme`,b=`_preferred_font_size`,x=[.6,.65,.7,.75,.8,.85,.9,.95,1],S=()=>(0,g.jsx)(c,{children:(0,g.jsxs)(`div`,{className:`space-y-4`,children:[(0,g.jsxs)(`div`,{className:`bg-accent-tertiary/20 rounded-lg p-6`,children:[(0,g.jsx)(`div`,{className:`text-base font-semibold text-title`,children:`Информация`}),(0,g.jsxs)(`ul`,{className:`text-sm text-text space-y-2 list-disc pl-4 mt-3`,children:[(0,g.jsx)(`li`,{children:`Все данные хранятся локально в вашем браузере`}),(0,g.jsx)(`li`,{children:`Данные не отправляются на серверы`}),(0,g.jsx)(`li`,{children:`Работает без интернета`}),(0,g.jsx)(`li`,{children:`Используйте экспорт для регулярного резервного копирования`})]})]}),(0,g.jsx)(C,{}),(0,g.jsx)(w,{}),(0,g.jsx)(T,{}),(0,g.jsx)(E,{}),(0,g.jsx)(D,{})]})}),C=()=>{let[e,t]=(0,_.useState)(window.localStorage.getItem(y)??`system`),[n,r]=(0,_.useState)(()=>{let e=Number(window.localStorage.getItem(b)??`1`);return Math.round(e*20)/20});return(0,_.useEffect)(()=>{let t=e=>{window.localStorage.setItem(y,e),o(e===`dark`||e===`system`&&window.matchMedia(`(prefers-color-scheme: dark)`).matches)};if(t(e),e===`system`){let e=window.matchMedia(`(prefers-color-scheme: dark)`),n=()=>{t(`system`)};return e.addEventListener(`change`,n),()=>{e.removeEventListener(`change`,n)}}},[e]),(0,_.useEffect)(()=>{window.document.documentElement.style.fontSize=`${n}rem`,window.localStorage.setItem(b,String(n))},[n]),(0,g.jsxs)(`div`,{className:`bg-surface rounded-lg shadow p-6`,children:[(0,g.jsx)(`div`,{className:`text-base font-semibold text-title`,children:`Настройки темы`}),(0,g.jsx)(`p`,{className:`text-text-medium text-sm mt-3`,children:`Выберите предпочитаемую цветовую схему для приложения.`}),(0,g.jsxs)(`div`,{className:`mt-2 flex gap-2`,children:[(0,g.jsxs)(`label`,{className:`flex-1 flex items-center justify-center h-10 rounded-lg text-sm ${e===`system`?`btn-primary`:`btn-secondary`}`,children:[(0,g.jsx)(`input`,{type:`radio`,name:`theme`,value:`system`,checked:e===`system`,onChange:()=>t(`system`),className:`hidden`}),`Системная`]}),(0,g.jsxs)(`label`,{className:`flex-1 flex items-center justify-center h-10 rounded-lg text-sm ${e===`light`?`btn-primary`:`btn-secondary`}`,children:[(0,g.jsx)(`input`,{type:`radio`,name:`theme`,value:`light`,checked:e===`light`,onChange:()=>t(`light`),className:`hidden`}),`Светлая`]}),(0,g.jsxs)(`label`,{className:`flex-1 flex items-center justify-center h-10 rounded-lg text-sm ${e===`dark`?`btn-primary`:`btn-secondary`}`,children:[(0,g.jsx)(`input`,{type:`radio`,name:`theme`,value:`dark`,checked:e===`dark`,onChange:()=>t(`dark`),className:`hidden`}),`Темная`]})]}),(0,g.jsx)(`p`,{className:`text-text-medium text-sm mt-5`,children:`Настройте размеры элементов интерфейса.`}),(0,g.jsx)(`div`,{className:`mt-2`,children:(0,g.jsx)(m,{value:n,onChange:e=>r(Number(e.target.value)),"aria-label":`Размер шрифта`,children:x.map(e=>(0,g.jsxs)(`option`,{value:e,children:[e*100,`%`]},e))})})]})},w=()=>{let t=e(),n=t.state===`submitting`&&t.formData?.get(`actionType`)===`export`;return(0,g.jsxs)(r,{className:`bg-surface rounded-lg shadow p-6`,method:`post`,children:[(0,g.jsx)(`input`,{type:`hidden`,name:`actionType`,value:`export`}),(0,g.jsx)(`div`,{className:`text-base font-semibold text-title`,children:`Экспорт данных`}),(0,g.jsx)(`p`,{className:`text-text text-sm mt-3`,children:`Скачайте все ваши данные в JSON формате для резервного копирования`}),(0,g.jsx)(d,{type:`submit`,disabled:n,btnStyle:`primary`,className:`h-11.5 mt-5 w-full`,children:n?`Экспортирование...`:`Экспортировать данные`})]})},T=()=>{let{data:e,submit:t,state:r}=n({key:`import`}),i=r!==`idle`;return(0,g.jsxs)(`div`,{className:`bg-surface rounded-lg shadow p-6`,children:[(0,g.jsx)(`div`,{className:`text-base font-semibold text-title`,children:`Импорт данных`}),(0,g.jsx)(`p`,{className:`text-text text-sm mt-3`,children:`Загрузите JSON файл с ранее сохраненными данными`}),(0,g.jsxs)(`label`,{className:`block mt-5`,children:[(0,g.jsx)(`input`,{type:`file`,accept:`.json`,name:`file`,onChange:e=>{let n=e.target.files?.[0];if(!n)return;let r=new FormData;r.append(`actionType`,`import`),r.append(`file`,n),t(r,{method:`post`,encType:`multipart/form-data`})},disabled:i,className:`hidden`}),(0,g.jsx)(`span`,{className:`btn-primary rounded-lg text-md h-11.5 w-full flex items-center justify-center`,children:i?`Импортирование...`:`Загрузить файл`})]}),e?.error&&(0,g.jsx)(`div`,{className:`mt-3`,children:(0,g.jsx)(p,{message:e.error})}),e?.imported&&!e?.error&&(0,g.jsx)(`div`,{className:`mt-3`,children:(0,g.jsxs)(p,{type:`success`,children:[`Импортировано:`,(0,g.jsxs)(`ul`,{className:`list-disc pl-5`,children:[(0,g.jsxs)(`li`,{children:[e.imported.clients,` `,h(e.imported.clients,[`клиент`,`клиента`,`клиентов`])]}),(0,g.jsxs)(`li`,{children:[e.imported.packages,` `,h(e.imported.packages,[`пакет`,`пакета`,`пакетов`])]}),(0,g.jsxs)(`li`,{children:[e.imported.attendance,` `,h(e.imported.attendance,[`посещение`,`посещения`,`посещений`])]})]})]})})]})},E=()=>{let{submit:e,state:t,data:r}=n({key:`startNewMonth`}),i=t!==`idle`;return(0,g.jsxs)(`div`,{className:`bg-accent-primary/10 rounded-lg p-6`,children:[(0,g.jsx)(`div`,{className:`text-base font-semibold text-title`,children:`Начать новый месяц`}),(0,g.jsxs)(`p`,{className:`text-sm text-text mt-3 whitespace-break-spaces`,children:[`Эта операция удалит все посещения и все использованные пакеты.`,(0,g.jsx)(`br`,{}),`Останутся только список клиентов и их активные пакеты.`,(0,g.jsx)(`br`,{}),`Эта операция не может быть отменена.`,(0,g.jsx)(`br`,{}),(0,g.jsx)(`strong`,{children:`Не забудьте сделать экспорт`}),` перед началом нового месяца!`]}),(0,g.jsx)(d,{onClick:()=>{if(confirm(`Вы уверены, что хотите начать новый месяц? Эта операция не может быть отменена.`)){let t=new FormData;t.append(`actionType`,`startNewMonth`),e(t,{method:`post`})}},disabled:i,btnStyle:`primary`,className:`h-11.5 w-full mt-5`,children:i?`Начало нового месяца...`:`Начать новый месяц`}),r?.error&&(0,g.jsx)(`div`,{className:`mt-3`,children:(0,g.jsx)(p,{message:r.error})}),r?.message&&!r?.error&&(0,g.jsx)(`div`,{className:`mt-3`,children:(0,g.jsx)(p,{message:r.message,type:`success`})})]})},D=()=>{let{submit:e,state:t,data:r}=n({key:`clear`}),i=t!==`idle`;return(0,g.jsxs)(`div`,{className:`bg-red-800/10 rounded-lg p-6`,children:[(0,g.jsx)(`div`,{className:`text-base font-semibold text-title`,children:`Опасная зона`}),(0,g.jsx)(`p`,{className:`text-sm text-text mt-3`,children:`Эта операция удалит все данные и не может быть отменена. Перед удалением сделайте экспорт!`}),(0,g.jsx)(d,{onClick:()=>{if(confirm(`Вы уверены? Это удалит ВСЕ данные! Эту операцию нельзя отменить!`)){let t=new FormData;t.append(`actionType`,`clearAll`),e(t,{method:`post`})}},disabled:i,btnStyle:`danger`,className:`h-11.5 w-full mt-5`,children:i?`Удаление...`:`Удалить все данные`}),r?.error&&(0,g.jsx)(`div`,{className:`mt-3`,children:(0,g.jsx)(p,{message:r.error})}),r?.message&&!r?.error&&(0,g.jsx)(`div`,{className:`mt-3`,children:(0,g.jsx)(p,{message:r.message,type:`success`})})]})},O=t(S);export{v as clientAction,O as default};