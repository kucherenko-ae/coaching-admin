import{D as e,L as t,N as n,R as r,V as i,i as a,j as o,k as s,z as c}from"./chunk-JZWAC4HX-pontpNwO.js";import{t as l}from"./jsx-runtime-Dg8orHAx.js";import{t as u}from"./Svg-Boi9_9HN.js";import{t as d}from"./useRootLoaderData-DQMeRxtp.js";import{o as f,t as p}from"./packages-TGpPiuli.js";import{t as m}from"./ItemCard-sX9X9Rp8.js";import"./Input-Cb6DeJHz.js";import{t as h}from"./formatLocalDate-CRv1zltC.js";import{t as g}from"./clients-CSXVs_1P.js";import{i as _,r as v}from"./SkeletonString-ClGUZjJc.js";import{t as y}from"./PackagesCard-iIIt1Vk9.js";import"./Select-BMcBtPcw.js";import{n as b,r as x,t as S}from"./reports.settings-Dj1_pqE3.js";var C=l(),w=i(c(),1);const T=async({request:t})=>{let n=new URL(t.url),r=n.searchParams.get(`dateRange`),i=n.searchParams.get(`from`),a=n.searchParams.get(`to`),o=!1;if(r||(r=`thisMonth`,[i,a]=_(`thisMonth`,Date.now()),o=!0),a||(a=h(new Date),o=!0),!i||new Date(i)>new Date(a)){let e=new Date(a);e.setDate(1),i=h(e),o=!0}if(o)throw n.searchParams.set(`dateRange`,r),n.searchParams.set(`from`,i),n.searchParams.set(`to`,a),e(n.toString());let[s,c]=await Promise.all([g.getAllSortedByName(),p.getByDateRange(i,a)]),l=n.searchParams.get(`clientId`);return{clients:s,packages:l?c.filter(e=>e.clientId===l):c}},E=async({request:e})=>{if(e.method!==`POST`)return new Response(`Method Not Allowed`,{status:405});let t=await e.formData(),n=t.get(`actionType`);if(!n)return new Response(`Missing actionType`,{status:400});switch(n){case`createOrUpdate`:{let e=t.get(`clientId`),n=t.get(`totalSessions`),r=t.get(`date`),i=t.get(`cost`),a=t.get(`packageId`),o=[];if(n||o.push(`totalSessions`),r||o.push(`date`),i||o.push(`cost`),e||o.push(`clientId`),o.length>0)return new Response(`Missing properties: ${o.join(`, `)}`,{status:400});let s=t.get(`remainingSessions`),c=Number(n),l=s?Math.min(Number(s),c):c;try{return a?await p.update(a,{clientId:e,cost:Number(i),totalSessions:c,remainingSessions:l,date:new Date(r).getTime()}):await p.create({clientId:e,cost:Number(i),totalSessions:c,remainingSessions:l,date:new Date(r).getTime()}),{ok:!0,error:null}}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Ошибка при создании пакета`}}}case`delete`:{let e=t.get(`packageId`);if(!e)return new Response(`Missing packageId for delete action`,{status:400});try{return await p.delete(e),{ok:!0,error:null}}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Ошибка при удалении пакета`}}}default:return new Response(`Unknown actionType`,{status:400})}};var D=()=>{let{now:e}=d(),{clients:r,packages:i}=o(),[a]=t(),s=n(),c=a.get(`dateRange`)??`thisMonth`;return(0,C.jsxs)(f,{children:[(0,C.jsx)(y,{packages:i,ranges:S,activeRange:c,onRangeChange:t=>{let n=new URLSearchParams(a);if(n.set(`dateRange`,t),t!==`custom`){let[r,i]=_(t,e);n.set(`from`,r),n.set(`to`,i)}s({search:n.toString()},{replace:!0})}}),(0,C.jsxs)(m,{background:`bg-accent-tertiary/15`,children:[c===`custom`&&(0,C.jsx)(x,{}),(0,C.jsx)(b,{clients:r})]}),(0,C.jsx)(O,{})]})},O=()=>{let{clients:e,packages:t}=o(),n=s(),r=n.state!==`idle`,i=(0,w.useMemo)(()=>{let t={};return e.forEach(e=>{t[e.id]=e.name}),t},[e]),c=e=>{confirm(`Вы уверены, что хотите удалить этот пакет?`)&&n.submit({actionType:`delete`,packageId:e},{method:`post`})};return(0,C.jsx)(`div`,{className:`space-y-3`,children:t.length===0?(0,C.jsxs)(`div`,{className:`text-center py-12 text-text-light`,children:[(0,C.jsx)(`p`,{className:`text-base`,children:`Нет оплат`}),(0,C.jsx)(`p`,{className:`text-sm mt-2`,children:`Выберите другой период`})]}):(0,C.jsx)(`div`,{className:`space-y-3`,children:t.map(e=>(0,C.jsxs)(m,{children:[(0,C.jsxs)(`div`,{className:`flex justify-between items-start`,children:[(0,C.jsx)(`div`,{className:`font-medium text-base text-title`,children:i[e.clientId]??e.clientName??`Неизвестный`}),(0,C.jsxs)(`div`,{className:`flex gap-1 -mx-1`,children:[(0,C.jsx)(a,{to:`/packages/${e.id}/edit`,className:`p-1 btn-icon`,"aria-label":`Редактировать пакет`,children:(0,C.jsx)(u,{name:`edit`,className:`size-4`})}),(0,C.jsx)(`button`,{onClick:()=>c(e.id),className:`p-1 btn-icon`,"aria-label":`Удалить пакет`,disabled:r,children:(0,C.jsx)(u,{name:`remove`,className:`size-4`})})]})]}),(0,C.jsxs)(`div`,{className:`flex justify-between items-center`,children:[(0,C.jsxs)(`div`,{className:`text-sm text-accent-secondary/70`,children:[e.cost.toLocaleString(`ru-RU`),` ₽`]}),(0,C.jsx)(`div`,{className:`text-sm text-text-medium`,children:new Date(e.date).toLocaleDateString(`ru-RU`)})]}),(0,C.jsxs)(`div`,{className:`bg-surface-sub rounded px-2 py-1 text-xs text-text space-y-1`,children:[(0,C.jsxs)(`div`,{className:`flex justify-between`,children:[(0,C.jsx)(`span`,{children:`Остаток тренировок:`}),(0,C.jsxs)(`span`,{className:`font-semibold`,children:[e.remainingSessions,` из `,e.totalSessions]})]}),(0,C.jsxs)(`div`,{className:`flex justify-between`,children:[(0,C.jsx)(`span`,{children:`Цена за тренировку:`}),(0,C.jsxs)(`span`,{className:`font-semibold`,children:[v(e.pricePerSession).toLocaleString(`ru-RU`),` ₽`]})]})]})]},e.id))})})},k=r(D);export{E as clientAction,T as clientLoader,k as default};