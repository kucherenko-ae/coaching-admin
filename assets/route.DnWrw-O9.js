import{M as e,N as t,R as n,V as r,j as i,k as a,z as o}from"./chunk-JZWAC4HX.B5xnh8v2.js";import"./ToastMessages.busEvents.rtsizd_v.js";import{t as s}from"./jsx-runtime.CWlfk1IU.js";import{t as c}from"./Svg.8sPTxAw7.js";import{t as l}from"./useRootLoaderData.DLGWmWvo.js";import{n as u,r as d,t as f}from"./FullscreenModalButtons.WN75SBcn.js";import{n as p,o as m,t as h}from"./packages.DEKZB-8t.js";import{t as g}from"./ItemCard.D3Xi8u2x.js";import{t as _}from"./Input.DT_H2j8k.js";import{t as v}from"./formatLocalDate.DBnePfWG.js";import"./Button.kaO_hKy8.js";import{t as y}from"./clients.BJCayMAs.js";import{t as b}from"./Textarea.BG1C_yOC.js";var x=o(),S=s();const C=()=>{let e=t(),{now:n}=l(),{clientsWithActivePackages:r}=i(),{data:o,state:s,reset:c,Form:p}=a(),[h,y]=(0,x.useState)(n),[b,C]=(0,x.useState)(null),[E,D]=(0,x.useState)(!1),O=s!==`idle`,k=O||!h||!E&&!b;return(0,x.useEffect)(()=>{!O&&o&&!o.error&&d.message({type:`success`,message:`Посещение успешно создано`}),o?.error&&d.message({type:`error`,message:`Что-то пошло не так`,details:`Пожалуйста попробуйте снова`}),o&&e(-1)},[O,o,c,e,s]),(0,S.jsxs)(p,{action:`/reports/attendance`,method:`post`,children:[(0,S.jsxs)(m,{children:[(0,S.jsx)(u,{color:`primary`,children:`Новое посещение`}),(0,S.jsxs)(g,{children:[(0,S.jsx)(_,{type:`date`,name:`date`,label:`Дата посещения *`,required:!0,defaultValue:v(new Date(h)),onChange:e=>{C(null),y(new Date(e.target.value).getTime())}}),(0,S.jsxs)(`div`,{className:`flex gap-2`,children:[(0,S.jsx)(`button`,{type:`button`,onClick:()=>{C(null),D(!1)},className:`flex-1 text-tiny rounded py-2 ${E?`btn-secondary`:`btn-primary`}`,children:`Отметить клиента`}),(0,S.jsx)(`button`,{type:`button`,onClick:()=>{C(null),D(!0)},className:`flex-1 text-tiny rounded py-1 ${E?`btn-primary`:`btn-secondary`}`,children:`Разовое посещение`})]})]}),E?(0,S.jsx)(T,{}):(0,S.jsx)(x.Suspense,{fallback:(0,S.jsx)(g,{children:(0,S.jsx)(`div`,{className:`text-tiny text-text-light italic`,children:`Загрузка посещений на выбранную дату...`})}),children:(0,S.jsx)(w,{clients:r,selectedClient:b,onSelect:C,date:h})})]}),(0,S.jsx)(f,{onClose:()=>e(-1),disabled:k,closeLabel:`Отмена`,submitLabel:`Отметить`})]})};var w=({clients:e,selectedClient:t,onSelect:n,date:r})=>{let[i,a]=(0,x.useState)(``),[o,s]=(0,x.useState)(!0),l=(0,x.use)(p.getByDateRange(r)),u=t?l.some(e=>e.clientId===t):!1,d=e.filter(e=>e.name.toLowerCase().includes(i.toLowerCase())&&(!o||!l.some(t=>t.clientId===e.id)));return(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)(`div`,{className:`sticky z-10 top-8 bg-background rounded-b-lg`,children:(0,S.jsx)(g,{children:(0,S.jsxs)(`div`,{className:`flex gap-2`,children:[(0,S.jsx)(_,{type:`text`,placeholder:`Поиск клиента`,value:i,onChange:e=>a(e.target.value),labelClassName:`flex-1`}),i.length>0&&(0,S.jsx)(`button`,{type:`button`,onClick:()=>a(``),className:`size-9.5 flex items-center justify-center btn-input-reset`,"aria-label":`Сбросить фильтр`,children:(0,S.jsx)(c,{className:`size-4`,name:`close-x`})})]})})}),(0,S.jsxs)(g,{children:[(0,S.jsx)(`input`,{type:`hidden`,name:`actionType`,value:`add`}),(0,S.jsx)(`input`,{type:`hidden`,name:`clientId`,value:t??``}),(0,S.jsxs)(`div`,{className:`flex justify-between items-center`,children:[(0,S.jsx)(`div`,{className:`text-sm`,children:`Выберите клиента`}),(0,S.jsxs)(`label`,{className:`flex items-center gap-2 text-tiny text-text-light italic justify-end`,children:[`Скрыть посетивших`,(0,S.jsx)(`input`,{type:`checkbox`,checked:o,onChange:()=>{n(``),s(!o)},className:`size-3`})]})]}),u&&(0,S.jsx)(`div`,{className:`text-xs text-red-600/90`,children:`Выбранный клиент уже имеет посещение на выбранную дату`}),d.length===0&&(0,S.jsx)(`div`,{className:`text-xs text-text-medium`,children:i.length>0?`Клиенты не найдены`:`Нет доступных клиентов с активными пакетами`}),(0,S.jsx)(`ul`,{className:`text-xs space-y-1`,children:d.map(e=>(0,S.jsx)(`li`,{className:`cursor-pointer px-2 py-3 border rounded-md ${t===e.id?`bg-accent-primary text-background border-accent-primary/10`:`bg-background/40 border-border-light`}`,onClick:()=>n(e.id),children:e.name},e.id))})]})]})},T=()=>(0,S.jsxs)(g,{children:[(0,S.jsx)(`input`,{type:`hidden`,name:`actionType`,value:`addSingle`}),(0,S.jsx)(_,{label:`Имя клиента *`,name:`clientName`,type:`text`,required:!0,placeholder:`Введите имя клиента`}),(0,S.jsx)(_,{label:`Стоимость разового посещения *`,name:`cost`,type:`number`,min:`0`,step:`0.01`,required:!0,placeholder:`Введите стоимость`})]});const E=()=>{let e=t(),{clients:n}=i(),{data:r,state:o,reset:s,Form:c}=a(),[l,p]=(0,x.useState)(``),h=o!==`idle`,v=n.some(e=>e.name.toLowerCase()===l.toLowerCase());return(0,x.useEffect)(()=>{!h&&r&&!r.error&&d.message({type:`success`,message:`Клиент успешно создан`}),r?.error&&d.message({type:`error`,message:`Что-то пошло не так`,details:`Пожалуйста попробуйте снова`}),r&&e(-1)},[h,r,s,e,o]),(0,S.jsx)(c,{method:`post`,action:`/clients`,children:(0,S.jsxs)(m,{children:[(0,S.jsx)(`input`,{type:`hidden`,name:`actionType`,value:`createOrUpdate`}),(0,S.jsx)(u,{color:`tertiary`,children:`Новый клиент`}),(0,S.jsxs)(g,{children:[(0,S.jsx)(_,{label:`Имя *`,type:`text`,name:`name`,required:!0,value:l,onChange:e=>p(e.target.value)}),v&&(0,S.jsx)(`div`,{className:`text-red-600 text-xs mt-1`,children:`Клиент с таким именем уже существует`}),(0,S.jsx)(_,{label:`Телефон`,type:`tel`,name:`phone`}),(0,S.jsx)(b,{label:`Заметки`,name:`notes`,rows:3})]}),(0,S.jsx)(f,{onClose:()=>e(-1),disabled:h,closeLabel:`Отмена`,submitLabel:`Добавить`})]})})},D=()=>{let e=t(),{now:n}=l(),{data:r,state:i,reset:o,Form:s}=a(),[c,p]=(0,x.useState)(n),[h,y]=(0,x.useState)(null),[b,C]=(0,x.useState)(!1),w=i!==`idle`,T=w||!c||!h;return(0,x.useEffect)(()=>{!w&&r&&!r.error&&d.message({type:`success`,message:`Пакет успешно создан`}),r?.error&&d.message({type:`error`,message:`Что-то пошло не так`,details:`Пожалуйста попробуйте снова`}),r&&e(-1)},[w,r,o,e,i]),(0,S.jsxs)(s,{action:`/reports/packages`,method:`post`,children:[(0,S.jsx)(`input`,{type:`hidden`,name:`actionType`,value:`createOrUpdate`}),(0,S.jsx)(`input`,{type:`hidden`,name:`clientId`,value:h??``}),(0,S.jsxs)(m,{children:[(0,S.jsx)(u,{color:`secondary`,children:`Новый пакет`}),(0,S.jsxs)(g,{children:[(0,S.jsx)(_,{type:`date`,name:`date`,label:`Дата посещения *`,required:!0,defaultValue:v(new Date(c)),onChange:e=>{y(null),p(new Date(e.target.value).getTime())}}),(0,S.jsx)(_,{label:`Стоимость пакета (₽) *`,type:`number`,name:`cost`,required:!0,min:`0`,step:`1`,placeholder:`13000`}),(0,S.jsx)(_,{label:`Количество тренировок *`,type:`number`,name:`totalSessions`,required:!0,min:`1`,step:`1`,defaultValue:`10`}),(0,S.jsxs)(`div`,{children:[(0,S.jsxs)(`label`,{className:`flex items-center gap-4 text-sm`,children:[(0,S.jsx)(`input`,{type:`checkbox`,checked:b,onChange:()=>C(!b),className:`size-4`}),`Начатый пакет`]}),(0,S.jsx)(`p`,{className:`text-tiny text-text-light mt-1`,children:`Позволяет изменить остаток тренировок в пакете. Включите эту опцию, если пакет уже начат, например когда вы переносите базу данных с уже начатыми пакетами.`})]}),b&&(0,S.jsx)(_,{label:`Остаток тренировок в пакете`,type:`number`,name:`remainingSessions`,min:`1`,step:`1`,defaultValue:10})]}),(0,S.jsx)(x.Suspense,{fallback:(0,S.jsx)(g,{children:(0,S.jsx)(`div`,{className:`text-tiny text-text-light italic`,children:`Загрузка пакетов на выбранную дату...`})}),children:(0,S.jsx)(O,{selectedClient:h,onSelect:y,date:c})})]}),(0,S.jsx)(f,{onClose:()=>e(-1),disabled:T,closeLabel:`Отмена`,submitLabel:`Отметить`})]})};var O=({selectedClient:e,onSelect:t,date:n})=>{let{clients:r}=i(),[a,o]=(0,x.useState)(``),[s,l]=(0,x.useState)(!0),u=(0,x.use)(h.getByDateRange(n)),d=e?u.some(t=>t.clientId===e):!1,f=r.filter(e=>e.name.toLowerCase().includes(a.toLowerCase())&&(!s||!u.some(t=>t.clientId===e.id)));return(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)(`div`,{className:`sticky z-10 top-8 bg-background rounded-b-lg`,children:(0,S.jsx)(g,{children:(0,S.jsxs)(`div`,{className:`flex gap-2`,children:[(0,S.jsx)(_,{type:`text`,placeholder:`Поиск клиента`,value:a,onChange:e=>o(e.target.value),labelClassName:`flex-1`}),a.length>0&&(0,S.jsx)(`button`,{type:`button`,onClick:()=>o(``),className:`size-9.5 flex items-center justify-center btn-input-reset`,"aria-label":`Сбросить фильтр`,children:(0,S.jsx)(c,{className:`size-4`,name:`close-x`})})]})})}),(0,S.jsxs)(g,{children:[(0,S.jsxs)(`div`,{className:`flex justify-between items-center`,children:[(0,S.jsx)(`div`,{className:`text-sm`,children:`Выберите клиента`}),(0,S.jsxs)(`label`,{className:`flex items-center gap-2 text-tiny text-text-light italic justify-end`,children:[`Скрыть приобретших`,(0,S.jsx)(`input`,{type:`checkbox`,checked:s,onChange:()=>{t(``),l(!s)},className:`size-3`})]})]}),d&&(0,S.jsx)(`div`,{className:`text-xs text-red-600/90`,children:`Выбранный клиент уже приобрел пакет на выбранную дату`}),f.length===0&&(0,S.jsx)(`div`,{className:`text-xs text-text-medium`,children:`Клиенты не найдены`}),(0,S.jsx)(`ul`,{className:`text-xs space-y-1`,children:f.map(n=>(0,S.jsx)(`li`,{className:`cursor-pointer px-2 py-3 border rounded-md ${e===n.id?`bg-accent-primary text-background border-accent-primary/10`:`bg-background/40 border-border-light`}`,onClick:()=>t(n.id),children:n.name},n.id))})]})]})};const k=async()=>{let[e,t]=await Promise.all([y.getAllSortedByName(),h.getAllActive()]),n=t.reduce((e,t)=>(e[t.clientId]||(e[t.clientId]=[]),e[t.clientId].push(t),e),{}),r=e.map(e=>{let t=(n[e.id]??[]).reduce((e,t)=>e+t.remainingSessions,0);return{...e,remainingSessions:t}});return{clients:r,clientsWithActivePackages:r.filter(e=>e.remainingSessions>0)}};var A=n(()=>{let t=e(),[n,r]=(0,x.useState)(()=>{let e=t.state?.from;switch(!0){case e?.includes(`/clients`):return`client`;case e?.includes(`/packages`):return`package`;default:return`attendance`}});return(0,S.jsxs)(S.Fragment,{children:[n===`attendance`&&(0,S.jsx)(C,{}),n===`client`&&(0,S.jsx)(E,{}),n===`package`&&(0,S.jsx)(D,{}),(0,S.jsxs)(`div`,{className:`safe-margin-bottom fixed z-10 bottom-18 left-2 flex gap-3`,children:[(0,S.jsx)(`button`,{type:`button`,onClick:()=>r(`attendance`),className:`h-9 flex-1 rounded-lg px-2 flex items-center justify-center text-xs shadow ${n===`attendance`?`bg-accent-primary text-background`:`btn-secondary`}`,children:`Посещение`}),(0,S.jsx)(`button`,{type:`button`,onClick:()=>r(`package`),className:`h-9 flex-1 rounded-lg px-2 flex items-center justify-center text-xs shadow ${n===`package`?`bg-accent-secondary text-background`:`btn-secondary`}`,children:`Пакет`}),(0,S.jsx)(`button`,{type:`button`,onClick:()=>r(`client`),className:`h-9 flex-1 rounded-lg px-2 flex items-center justify-center text-xs shadow ${n===`client`?`bg-accent-tertiary text-background`:`btn-secondary`}`,children:`Клиент`})]})]})});export{k as clientLoader,A as default};