import{R as e,i as t,j as n,k as r,z as i}from"./chunk-JZWAC4HX-DMio0XPM.js";import{t as a}from"./jsx-runtime-xdwC5iDu.js";import{t as o}from"./Svg-Bo1LYJ9e.js";import{o as s,t as c}from"./packages-CR-KDM1P.js";import{t as l}from"./ItemCard-DIyTdqtf.js";import{t as u}from"./Input-XyNqaCmh.js";import{t as d}from"./clients-DQQRwYQZ.js";import{t as f}from"./Message-BdcguyLo.js";var p=a(),m=i();const h=async()=>{let[e,t]=await Promise.all([d.getAllSortedByName(),c.getAllActive()]),n=t.reduce((e,t)=>(e[t.clientId]||(e[t.clientId]=[]),e[t.clientId].push(t),e),{});return e.map(e=>{let t=(n[e.id]??[]).reduce((e,t)=>e+t.remainingSessions,0);return{...e,remainingSessions:t}})},g=async({request:e})=>{if(e.method!==`POST`)return new Response(`Method Not Allowed`,{status:405});let t=await e.formData(),n=t.get(`actionType`);if(!n)return new Response(`Missing actionType`,{status:400});switch(n){case`delete`:{let e=t.get(`clientId`);if(!e)return new Response(`Missing clientId for delete action`,{status:400});try{return await d.delete(e),{ok:!0,error:null}}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Ошибка при удалении`}}}case`createOrUpdate`:{let e=t.get(`name`),n=t.get(`notes`)??``,r=t.get(`phone`)??``,i=t.get(`clientId`),a=[];if(e||a.push(`name`),a.length>0)return new Response(`Missing properties: ${a.join(`, `)}`,{status:400});try{return i?await d.update(i,{name:e,notes:n,phone:r}):await d.create({name:e,notes:n,phone:r}),{ok:!0,error:null}}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Ошибка при сохранении`}}}}};var _=()=>{let e=n(),[t,r]=(0,m.useState)(``),[i,a]=(0,m.useState)(!0),[o,c]=(0,m.useState)(!0),[d,f]=(0,m.useState)(!0);if(!e.length)return(0,p.jsx)(s,{children:(0,p.jsxs)(l,{className:`text-center`,children:[(0,p.jsx)(`p`,{className:`text-base`,children:`Нет клиентов`}),(0,p.jsx)(`p`,{className:`text-sm mt-2`,children:`Добавьте первого клиента`})]})});let h=e.filter(e=>e.name.toLowerCase().includes(t.toLowerCase())&&(i&&e.remainingSessions===0||o&&e.remainingSessions>=1&&e.remainingSessions<=3||d&&e.remainingSessions>3));return(0,p.jsxs)(s,{children:[(0,p.jsxs)(l,{className:`sticky z-10 top-4`,children:[(0,p.jsx)(u,{type:`text`,placeholder:`Поиск клиента`,value:t,onChange:e=>r(e.target.value),labelClassName:`flex-1`}),(0,p.jsxs)(`div`,{className:`flex items-center gap-2`,children:[(0,p.jsx)(`div`,{className:`text-tiny text-text-light`,children:`Остаток тренировок: `}),(0,p.jsxs)(`div`,{className:`flex gap-2`,children:[(0,p.jsx)(`button`,{type:`button`,className:`text-tiny w-8 h-5.5 rounded whitespace-nowrap ${i?`btn-primary`:`btn-secondary`}`,onClick:()=>{a(!i)},children:`0`}),(0,p.jsx)(`button`,{type:`button`,className:`text-tiny w-8 h-5.5 rounded whitespace-nowrap ${o?`btn-primary`:`btn-secondary`}`,onClick:()=>{c(!o)},children:`1 - 3`}),(0,p.jsx)(`button`,{type:`button`,className:`text-tiny w-8 h-5.5 rounded whitespace-nowrap ${d?`btn-primary`:`btn-secondary`}`,onClick:()=>{f(!d)},children:`4 +`})]})]})]}),h.length===0?(0,p.jsx)(l,{children:(0,p.jsx)(`div`,{className:`text-xs text-text-medium`,children:`Клиенты не найдены`})}):(0,p.jsx)(`div`,{className:`space-y-3`,children:h.map(e=>(0,p.jsx)(v,{client:e},e.id))})]})},v=({client:e})=>{let n=r({key:e.id}),i=n.state!==`idle`,a=()=>{confirm(`Удалить клиента и все связанные данные?`)&&n.submit({clientId:e.id,actionType:`delete`},{method:`post`})};return(0,p.jsxs)(l,{children:[(0,p.jsxs)(`div`,{className:`flex justify-between items-start`,children:[(0,p.jsxs)(`div`,{className:`flex-1`,children:[(0,p.jsx)(`div`,{className:`font-medium text-base text-title`,children:e.name}),e.phone&&(0,p.jsx)(`a`,{href:`tel:${e.phone.replace(/[^\d+]|(?!^)\+/g,``)}`,className:`text-accent-secondary/70 text-sm  font-light`,children:e.phone})]}),(0,p.jsxs)(`div`,{className:`flex gap-1 -mx-1`,children:[(0,p.jsx)(t,{to:`/clients/${e.id}/edit`,className:`p-1 btn-icon`,"aria-label":`Редактировать клиента`,children:(0,p.jsx)(o,{name:`edit`,className:`size-4`})}),(0,p.jsx)(`button`,{onClick:a,className:`p-1 btn-icon`,"aria-label":`Удалить клиента`,disabled:i,children:(0,p.jsx)(o,{name:`remove`,className:`size-4`})})]})]}),e.notes&&(0,p.jsx)(`div`,{className:`text-text-medium text-sm font-light`,children:e.notes}),(0,p.jsx)(`div`,{className:`${e.remainingSessions<2?`text-red-600`:`text-text`} bg-surface-sub rounded px-2 py-1 text-xs space-y-1`,children:(0,p.jsxs)(`div`,{className:`flex justify-between`,children:[(0,p.jsx)(`span`,{children:`Остаток тренировок:`}),(0,p.jsx)(`span`,{className:`font-semibold`,children:e.remainingSessions})]})}),n.data?.error&&(0,p.jsx)(f,{message:n.data.error})]},e.id)},y=e(_);export{g as clientAction,h as clientLoader,y as default};